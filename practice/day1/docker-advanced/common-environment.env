# ê³µí†µ í™˜ê²½ ì„¤ì • íŒŒì¼
# Cloud Intermediate ê³¼ì •ìš© ê³µí†µ ì„¤ì •
# 
# ì‚¬ìš©ë²•: source common-environment.env
# ë˜ëŠ”: export $(cat common-environment.env | xargs)

# =============================================================================
# ê³µí†µ ì„¤ì •
# =============================================================================
export PROJECT_NAME="cloud-intermediate"
export ENVIRONMENT="development"
export DEBUG_MODE="true"
export LOG_LEVEL="INFO"

# =============================================================================
# ìƒ‰ìƒ ë° ë¡œê¹… ì„¤ì •
# =============================================================================
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[1;33m'
export BLUE='\033[0;34m'
export PURPLE='\033[0;35m'
export CYAN='\033[0;36m'
export NC='\033[0m'

# =============================================================================
# ë¡œê·¸ í•¨ìˆ˜ ì •ì˜
# =============================================================================
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_header() { echo -e "${PURPLE}=== $1 ===${NC}"; }
log_step() { echo -e "${CYAN}[STEP]${NC} $1"; }

# =============================================================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# =============================================================================
check_command() {
    local cmd="$1"
    if command -v "$cmd" &> /dev/null; then
        log_success "âœ… $cmd: ì„¤ì¹˜ë¨"
        return 0
    else
        log_error "âŒ $cmd: ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ"
        return 1
    fi
}

check_environment() {
    local provider="$1"
    case "$provider" in
        "aws")
            check_command "aws" && check_command "kubectl" && check_command "eksctl"
            ;;
        "gcp")
            check_command "gcloud" && check_command "kubectl"
            ;;
        *)
            log_error "ì§€ì›í•˜ì§€ ì•ŠëŠ” í”„ë¡œë°”ì´ë”: $provider"
            return 1
            ;;
    esac
}

# =============================================================================
# ë””ë ‰í† ë¦¬ ì„¤ì •
# =============================================================================
export TOOLS_DIR="$(dirname "$0")"
export AUTOMATION_DIR="$(dirname "$TOOLS_DIR")/automation"
export SAMPLES_DIR="$(dirname "$TOOLS_DIR")/samples"
export LOGS_DIR="$TOOLS_DIR/logs"

# =============================================================================
# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
# =============================================================================
mkdir -p "$LOGS_DIR"

# =============================================================================
# íƒ€ì„ìŠ¤íƒ¬í”„ ì„¤ì •
# =============================================================================
export TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
export LOG_FILE="$LOGS_DIR/cloud-intermediate_${TIMESTAMP}.log"

# =============================================================================
# ë¡œê·¸ í•¨ìˆ˜ (íŒŒì¼ ì¶œë ¥ í¬í•¨)
# =============================================================================
log_to_file() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

log_info_file() { 
    log_info "$1"
    log_to_file "INFO: $1"
}

log_success_file() { 
    log_success "$1"
    log_to_file "SUCCESS: $1"
}

log_warning_file() { 
    log_warning "$1"
    log_to_file "WARNING: $1"
}

log_error_file() { 
    log_error "$1"
    log_to_file "ERROR: $1"
}

# =============================================================================
# ì—ëŸ¬ ì²˜ë¦¬ ì„¤ì •
# =============================================================================
set -e
set -u
set -o pipefail

# =============================================================================
# íŠ¸ë© ì„¤ì • (ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì‹œ ì •ë¦¬)
# =============================================================================
cleanup() {
    log_info "ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì‹œ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰"
    # í•„ìš”í•œ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰
}

trap cleanup EXIT

# =============================================================================
# ì§„í–‰ ìƒí™© ì¶”ì 
# =============================================================================
export PROGRESS_FILE="$LOGS_DIR/progress_${TIMESTAMP}.json"

init_progress() {
    cat > "$PROGRESS_FILE" << EOF
{
    "timestamp": "$TIMESTAMP",
    "status": "started",
    "steps": [],
    "resources": {
        "created": [],
        "existing": [],
        "modified": [],
        "deleted": []
    },
    "errors": []
}
EOF
}

update_progress() {
    local step="$1"
    local status="$2"
    local message="$3"
    
    # JSON ì—…ë°ì´íŠ¸ (jqê°€ ìˆëŠ” ê²½ìš°)
    if command -v jq &> /dev/null; then
        jq --arg step "$step" --arg status "$status" --arg message "$message" \
           '.steps += [{"step": $step, "status": $status, "message": $message, "timestamp": now}]' \
           "$PROGRESS_FILE" > "$PROGRESS_FILE.tmp" && mv "$PROGRESS_FILE.tmp" "$PROGRESS_FILE"
    else
        # jqê°€ ì—†ëŠ” ê²½ìš° ê°„ë‹¨í•œ ë¡œê·¸ ì¶”ê°€
        echo "$(date '+%Y-%m-%d %H:%M:%S') - $step: $status - $message" >> "$PROGRESS_FILE"
    fi
}

# =============================================================================
# ë¦¬ì†ŒìŠ¤ ìƒíƒœ í™•ì¸
# =============================================================================
check_resource_exists() {
    local resource_type="$1"
    local resource_name="$2"
    local provider="$3"
    
    case "$provider" in
        "aws")
            case "$resource_type" in
                "cluster")
                    aws eks describe-cluster --name "$resource_name" &> /dev/null
                    ;;
                "vpc")
                    aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$resource_name" &> /dev/null
                    ;;
                *)
                    log_warning "ì•Œ ìˆ˜ ì—†ëŠ” ë¦¬ì†ŒìŠ¤ íƒ€ì…: $resource_type"
                    return 1
                    ;;
            esac
            ;;
        "gcp")
            case "$resource_type" in
                "cluster")
                    gcloud container clusters describe "$resource_name" --zone="$GCP_ZONE" &> /dev/null
                    ;;
                "vpc")
                    gcloud compute networks describe "$resource_name" &> /dev/null
                    ;;
                *)
                    log_warning "ì•Œ ìˆ˜ ì—†ëŠ” ë¦¬ì†ŒìŠ¤ íƒ€ì…: $resource_type"
                    return 1
                    ;;
            esac
            ;;
        *)
            log_error "ì§€ì›í•˜ì§€ ì•ŠëŠ” í”„ë¡œë°”ì´ë”: $provider"
            return 1
            ;;
    esac
}

# =============================================================================
# ì§„í–‰ ìƒí™© ìš”ì•½ ë³´ê³ 
# =============================================================================
generate_summary() {
    log_header "ì‹¤í–‰ ìš”ì•½ ë³´ê³ "
    
    if [ -f "$PROGRESS_FILE" ]; then
        if command -v jq &> /dev/null; then
            local created_count=$(jq '.resources.created | length' "$PROGRESS_FILE")
            local existing_count=$(jq '.resources.existing | length' "$PROGRESS_FILE")
            local modified_count=$(jq '.resources.modified | length' "$PROGRESS_FILE")
            local deleted_count=$(jq '.resources.deleted | length' "$PROGRESS_FILE")
            local error_count=$(jq '.errors | length' "$PROGRESS_FILE")
            
            log_info "ğŸ“Š ë¦¬ì†ŒìŠ¤ ìƒíƒœ:"
            log_info "  - ìƒˆë¡œ ìƒì„±: $created_countê°œ"
            log_info "  - ê¸°ì¡´ ì‚¬ìš©: $existing_countê°œ"
            log_info "  - ìˆ˜ì •ë¨: $modified_countê°œ"
            log_info "  - ì‚­ì œë¨: $deleted_countê°œ"
            log_info "  - ì˜¤ë¥˜: $error_countê°œ"
        else
            log_info "ğŸ“Š ì§„í–‰ ìƒí™© íŒŒì¼: $PROGRESS_FILE"
        fi
    else
        log_warning "ì§„í–‰ ìƒí™© íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    fi
}

# =============================================================================
# =============================================================================
# GitHub ì„¤ì •
# =============================================================================
export GITHUB_REPO="cloud-intermediate-repo"
export GITHUB_ORG="your-github-org"
export GITHUB_TOKEN=""

# =============================================================================
# ì´ˆê¸°í™”
# =============================================================================
init_progress
log_info "ê³µí†µ í™˜ê²½ ì„¤ì • ë¡œë“œ ì™„ë£Œ"